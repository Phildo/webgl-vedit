<html>
<head>
<title>Low-Pixel 3D</title>
</head>

<script type='text/javascript' src='GL/utils/gl-matrix.js'></script>
<script type='text/javascript' src='GL/utils/webgl-utils.js'></script>
<script type='text/javascript' src='GL/GLMan.js'></script>
<script type='text/javascript' src='GL/XGLProgram.js'></script>
<script type='text/javascript' src='GL/GeoGLProgram.js'></script>
<script type='text/javascript' src='GL/XGLGeo.js'></script>
<script type='text/javascript' src='GL/XGLLight.js'></script>
<script type='text/javascript' src='utils/AsyncLoaderMan.js'></script>
<script type='text/javascript' src='utils/InputMan.js'></script>

<script type='text/javascript'>
//Managers
var alm;//AsyncLoadMan
var glm;//GLMan
var im;//InputMan

var lights = [];
var currentLight;
var tris = [];
var currentTri;

var currentEditor = "tri";

var dirtybit = true;

function loadContent()
{
  //Init the men
  alm = new AsyncLoaderMan();
  glm = new GLMan(640, 320);
  im = new InputMan();

  //Load the shaders
  alm.loadBatch(new AsyncLoaderBatch(
    ['GL/shaders/geovshader.txt',
    'GL/shaders/geofshader.txt'],
    ['geovs','geofs'], 
    compileShaderDataFromFiles));
}

function compileShaderDataFromFiles(returnObj)
{
  if(!returnObj) { alert('Error loading Shaders... :/'); return; }

  //Positioning of the canvas on the DOM
  document.getElementById('render_area').insertBefore(glm.canvas,document.getElementById('shadow'));

  //Use the shaders
  glm.setProgram("geo",returnObj.geovs,returnObj.geofs);

  addLight();

  glm.geoProgram.compileStaticData();

  //Move the camera a bit
  mat4.translate(glm.geoProgram.camMatData,[0,0,10.0]);

  //Start the clock
  requestAnimFrame(tick,glm.canvas);
}

function switchEditor()
{
  switch(currentEditor)
  {
    case "tri":
      currentEditor = "light";
      document.getElementById('tri_editor').style.display = 'none';
      document.getElementById('tri_selector').style.display = 'none';
      document.getElementById('editor_selector').value = 'switch to tri editor';
      document.getElementById('light_editor').style.display = 'block';
      document.getElementById('light_selector').style.display = 'block';
      break;
    case "light":
      currentEditor = "tri";
      document.getElementById('light_editor').style.display = 'none';
      document.getElementById('light_selector').style.display = 'none';
      document.getElementById('editor_selector').value = 'switch to light editor';
      document.getElementById('tri_editor').style.display = 'block';
      document.getElementById('tri_selector').style.display = 'block';
      break;
  }
}

function addTri()
{
  tris[tris.length] = new XGLGeo([0,0,0, 1,0,0, 0,1,1], [0.5,0.5,0.5, 0.5,0.5,0.5, 0.5,0.5,0.5], [0,1,0, 0,1,0, 0,1,0], [0,1,2]);
  glm.geoProgram.addGeo(tris[tris.length-1]);
  editTri(tris.length-1);

  var trirep = document.createElement('div');
  trirep.innerHTML=tris.length-1;
  trirep.style.width='10px';
  trirep.style.height='10px';
  trirep.style.border='1px solid black;';
  trirep.style.margin='2px';
  trirep.setAttribute('onclick','editTri('+(tris.length-1)+')');
  document.getElementById('tri_selector').appendChild(trirep);

  glm.geoProgram.compileStaticData();
  dirtybit = true;
}

function deleteTri()
{
  if(!currentTri) return;
  tris.splice(currentTri.programGeoListIndex,1);
  glm.geoProgram.removeGeo(currentTri);
  document.getElementById('tri_selector').removeChild(document.getElementById('tri_selector').children[tris.length]);
  editTri(0);

  glm.geoProgram.compileStaticData();
  dirtybit = true;
}

function editTri(index)
{
  currentTri = tris[index];
  if(!currentTri) return;

  document.getElementById('trivert1x').value = currentTri.verts[0];
  document.getElementById('trivert1y').value = currentTri.verts[1];
  document.getElementById('trivert1z').value = currentTri.verts[2];
  document.getElementById('trivert2x').value = currentTri.verts[3];
  document.getElementById('trivert2y').value = currentTri.verts[4];
  document.getElementById('trivert2z').value = currentTri.verts[5];
  document.getElementById('trivert3x').value = currentTri.verts[6];
  document.getElementById('trivert3y').value = currentTri.verts[7];
  document.getElementById('trivert3z').value = currentTri.verts[8];

  document.getElementById('tricolor1r').value = currentTri.colors[0];
  document.getElementById('tricolor1g').value = currentTri.colors[1];
  document.getElementById('tricolor1b').value = currentTri.colors[2];
  document.getElementById('tricolor2r').value = currentTri.colors[3];
  document.getElementById('tricolor2g').value = currentTri.colors[4];
  document.getElementById('tricolor2b').value = currentTri.colors[5];
  document.getElementById('tricolor3r').value = currentTri.colors[6];
  document.getElementById('tricolor3g').value = currentTri.colors[7];
  document.getElementById('tricolor3b').value = currentTri.colors[8];

  document.getElementById('trinorm1x').value = currentTri.normals[0];
  document.getElementById('trinorm1y').value = currentTri.normals[1];
  document.getElementById('trinorm1z').value = currentTri.normals[2];
  document.getElementById('trinorm2x').value = currentTri.normals[3];
  document.getElementById('trinorm2y').value = currentTri.normals[4];
  document.getElementById('trinorm2z').value = currentTri.normals[5];
  document.getElementById('trinorm3x').value = currentTri.normals[6];
  document.getElementById('trinorm3y').value = currentTri.normals[7];
  document.getElementById('trinorm3z').value = currentTri.normals[8];

}

function saveTri()
{
  if(!currentTri) return;

  currentTri.verts[0] = document.getElementById('trivert1x').value;
  currentTri.verts[1] = document.getElementById('trivert1y').value;
  currentTri.verts[2] = document.getElementById('trivert1z').value;
  currentTri.verts[3] = document.getElementById('trivert2x').value;
  currentTri.verts[4] = document.getElementById('trivert2y').value;
  currentTri.verts[5] = document.getElementById('trivert2z').value;
  currentTri.verts[6] = document.getElementById('trivert3x').value;
  currentTri.verts[7] = document.getElementById('trivert3y').value;
  currentTri.verts[8] = document.getElementById('trivert3z').value;

  currentTri.colors[0] = document.getElementById('tricolor1r').value;
  currentTri.colors[1] = document.getElementById('tricolor1g').value;
  currentTri.colors[2] = document.getElementById('tricolor1b').value;
  currentTri.colors[3] = document.getElementById('tricolor2r').value;
  currentTri.colors[4] = document.getElementById('tricolor2g').value;
  currentTri.colors[5] = document.getElementById('tricolor2b').value;
  currentTri.colors[6] = document.getElementById('tricolor3r').value;
  currentTri.colors[7] = document.getElementById('tricolor3g').value;
  currentTri.colors[8] = document.getElementById('tricolor3b').value;

  currentTri.normals[0] = document.getElementById('trinorm1x').value;
  currentTri.normals[1] = document.getElementById('trinorm1y').value;
  currentTri.normals[2] = document.getElementById('trinorm1z').value;
  currentTri.normals[3] = document.getElementById('trinorm2x').value;
  currentTri.normals[4] = document.getElementById('trinorm2y').value;
  currentTri.normals[5] = document.getElementById('trinorm2z').value;
  currentTri.normals[6] = document.getElementById('trinorm3x').value;
  currentTri.normals[7] = document.getElementById('trinorm3y').value;
  currentTri.normals[8] = document.getElementById('trinorm3z').value;

  glm.geoProgram.compileStaticData();
  dirtybit = true;
}

function addLight()
{
  lights[lights.length] = new XGLLight([0,0,0]);
  glm.geoProgram.addLight(lights[lights.length-1]);
  editLight(lights.length-1);

  var lightrep = document.createElement('div');
  lightrep.innerHTML=lights.length-1;
  lightrep.style.width='10px';
  lightrep.style.height='10px';
  lightrep.style.border='1px solid black;';
  lightrep.style.margin='2px';
  lightrep.setAttribute('onclick','editLight('+(lights.length-1)+')');
  document.getElementById('light_selector').appendChild(lightrep);

  glm.geoProgram.compileStaticData();
  dirtybit = true;
}

function deleteLight()
{
  if(!currentLight || lights.length == 1) return;
  lights.splice(currentLight.programLightListIndex,1);
  glm.geoProgram.removeLight(currentLight);
  document.getElementById('light_selector').removeChild(document.getElementById('light_selector').children[lights.length]);
  editLight(0);

  glm.geoProgram.compileStaticData();
  dirtybit = true;
}

function editLight(index)
{
  currentLight = lights[index];
  if(!currentLight) return;

  document.getElementById('lightposx').value = currentLight.position[0];
  document.getElementById('lightposy').value = currentLight.position[1];
  document.getElementById('lightposz').value = currentLight.position[2];
}

function saveLight()
{
  currentLight.setPosition(parseFloat(document.getElementById('lightposx').value), parseFloat(document.getElementById('lightposy').value), parseFloat(document.getElementById('lightposz').value));

  glm.geoProgram.compileStaticData();
  dirtybit = true;
}

function outputJSON()
{
  var verts = [];
  var colors = [];
  var normals = [];
  var indexes = [];
  var lightposs = [];

  for(var i = 0; i < tris.length; i++)
  {
    verts[verts.length] = tris[i].verts[0];
    verts[verts.length] = tris[i].verts[1];
    verts[verts.length] = tris[i].verts[2];
    verts[verts.length] = tris[i].verts[3];
    verts[verts.length] = tris[i].verts[4];
    verts[verts.length] = tris[i].verts[5];
    verts[verts.length] = tris[i].verts[6];
    verts[verts.length] = tris[i].verts[7];
    verts[verts.length] = tris[i].verts[8];

    colors[colors.length] = tris[i].colors[0];
    colors[colors.length] = tris[i].colors[1];
    colors[colors.length] = tris[i].colors[2];
    colors[colors.length] = tris[i].colors[3];
    colors[colors.length] = tris[i].colors[4];
    colors[colors.length] = tris[i].colors[5];
    colors[colors.length] = tris[i].colors[6];
    colors[colors.length] = tris[i].colors[7];
    colors[colors.length] = tris[i].colors[8];

    normals[normals.length] = tris[i].normals[0];
    normals[normals.length] = tris[i].normals[1];
    normals[normals.length] = tris[i].normals[2];
    normals[normals.length] = tris[i].normals[3];
    normals[normals.length] = tris[i].normals[4];
    normals[normals.length] = tris[i].normals[5];
    normals[normals.length] = tris[i].normals[6];
    normals[normals.length] = tris[i].normals[7];
    normals[normals.length] = tris[i].normals[8];

    indexes[indexes.length] = indexes.length;
    indexes[indexes.length] = indexes.length;
    indexes[indexes.length] = indexes.length;
  }
  for(var i = 0; i < lights.length; i++)
  {
    lightposs[lightposs.length] = lights[i].position[0];
    lightposs[lightposs.length] = lights[i].position[1];
    lightposs[lightposs.length] = lights[i].position[2];
  }

  var Geo = {};
  Geo.verts = verts;
  Geo.colors = colors;
  Geo.normals = normals;
  Geo.indexes = indexes;
  Geo.lights = lightposs;

  document.getElementById('json_display').innerHTML = JSON.stringify(Geo);
}

function tick()
{
  requestAnimFrame(tick,glm.canvas);

  if(im.up || im.w) { mat4.translate(glm.geoProgram.camMatData,[0,0,-0.3]); dirtybit = true; }
  if(im.down || im.s) { mat4.translate(glm.geoProgram.camMatData,[0,0,0.3]); dirtybit = true; }
  if(im.a) { mat4.translate(glm.geoProgram.camMatData,[-0.3,0,0]); dirtybit = true; }
  if(im.d) { mat4.translate(glm.geoProgram.camMatData,[0.3,0,0]); dirtybit = true; }
  if(im.space) { mat4.translate(glm.geoProgram.camMatData,[0,0.3,0]); dirtybit = true; }
  if(im.shift) { mat4.translate(glm.geoProgram.camMatData,[0,-0.3,0]); dirtybit = true; }
  if(im.left) { mat4.rotate(glm.geoProgram.camMatData,0.03,[0,1,0]); dirtybit = true; }
  if(im.right) { mat4.rotate(glm.geoProgram.camMatData,-0.03,[0,1,0]); dirtybit = true; }

  if(dirtybit)
  {
    glm.draw();
    dirtybit = false;
  }
}

window.addEventListener('load', loadContent, false);
window.addEventListener('keypress', function(e) { if(e.keyCode == 13) /*ENTER*/ { if(currentEditor == "light") saveLight(); else if(currentEditor == "tri") saveTri(); document.focus(); } }, false);
</script>
<body>

<div id='edit_area' style='float:left; margin:20px;'>
  <div id='tri_editor' class='editor'>
    <input type='button' value='add tri' onclick='addTri();'></input><br />
    <input type='button' value='delete tri' onclick='deleteTri();'></input><br />

    Verts:<br />
    <input id='trivert1x' type='text' size='5'></input>
    <input id='trivert1y' type='text' size='5'></input>
    <input id='trivert1z' type='text' size='5'></input><br />
    <input id='trivert2x' type='text' size='5'></input>
    <input id='trivert2y' type='text' size='5'></input>
    <input id='trivert2z' type='text' size='5'></input><br />
    <input id='trivert3x' type='text' size='5'></input>
    <input id='trivert3y' type='text' size='5'></input>
    <input id='trivert3z' type='text' size='5'></input><br />
  
    Colors:<br />
    <input id='tricolor1r' type='text' size='5'></input>
    <input id='tricolor1g' type='text' size='5'></input>
    <input id='tricolor1b' type='text' size='5'></input><br />
    <input id='tricolor2r' type='text' size='5'></input>
    <input id='tricolor2g' type='text' size='5'></input>
    <input id='tricolor2b' type='text' size='5'></input><br />
    <input id='tricolor3r' type='text' size='5'></input>
    <input id='tricolor3g' type='text' size='5'></input>
    <input id='tricolor3b' type='text' size='5'></input><br />
  
    Normals:<br />
    <input id='trinorm1x' type='text' size='5'></input>
    <input id='trinorm1y' type='text' size='5'></input>
    <input id='trinorm1z' type='text' size='5'></input><br />
    <input id='trinorm2x' type='text' size='5'></input>
    <input id='trinorm2y' type='text' size='5'></input>
    <input id='trinorm2z' type='text' size='5'></input><br />
    <input id='trinorm3x' type='text' size='5'></input>
    <input id='trinorm3y' type='text' size='5'></input>
    <input id='trinorm3z' type='text' size='5'></input><br />
  
    <input type='button' value='save tri' onclick='saveTri();'></input>
  
  </div>

  <div id='light_editor' class='editor' style='display:none;'>
    <input type='button' value='add light' onclick='addLight();'></input><br />
    <input type='button' value='delete light' onclick='deleteLight();'></input><br />

    Pos:<br />
    <input id='lightposx' type='text' size='5'></input>
    <input id='lightposy' type='text' size='5'></input>
    <input id='lightposz' type='text' size='5'></input><br />
  
    <input type='button' value='save light' onclick='saveLight();'></input>
  
  </div>

</div>

<div id='render_area' style='width:640px; float:left; margin:20px;'>
  <input id='editor_selector' type='button' value='switch to light editor' onclick='switchEditor();'></input>
  <input id='json_printer' type='button' value='output JSON' onclick='outputJSON();'></input><br />
  <img id='shadow' src='images/shadow.png' style='display:block;'></img>
  <div id='json_display' style='width:640px;'></div>
</div>

<div id='select_area' style='float:left; margin:20px;'>
  <div id='tri_selector' class='selector'>
  </div>
  <div id='light_selector' class='selector' style='display:none;'>
  </div>
</div>

</body>
</html>
